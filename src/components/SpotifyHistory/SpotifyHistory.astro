---
export const prerender = false;
import { getCurrentAndRecentTracks } from "../../api/api";
import { PlayHistory } from "../../api/types";
import SpotifyTrackCard from "./SpotifyTrackCard.astro";

function filterRepeats<T>(arr: T[], eq: (a: T, b: T) => boolean ): T[] {
    let filtered: T[] = [];
    for (const item of arr) {
        if (filtered.length === 0 || !eq(item, filtered[filtered.length - 1])) {
            filtered.push(item);
        }
    }
    return filtered;
}

function smallestAcceptableImage(track: PlayHistory, minWidth: number, minHeight: number): string | null {
    let smallestArea = Number.MAX_SAFE_INTEGER;
    let smallestImageUrl = null;
    for (const image of track.track.album.images) {
        if (image.height < minHeight || image.width < minWidth) {
            continue;
        }
        const area = image.height * image.width;
        if (area < smallestArea) {
            smallestArea = area;
            smallestImageUrl = image.url;
        }
    }

    console.log(`CM return image size=${Math.sqrt(smallestArea)} url=${smallestImageUrl}`)
    return smallestImageUrl;
}

const tracks = await getCurrentAndRecentTracks(20);
const history = filterRepeats(tracks, (a, b) => a.track.id === b.track.id);
const images = tracks.map(track => smallestAcceptableImage(track, 120, 120));
---

<style>
    ul#spotifyHistory {
        width: calc(100% - 16px);
        margin: 0 auto;

        list-style: none;
        display: flex;
        flex-direction: row;
        overflow: auto;
        white-space: nowrap;

        padding-left: unset;
    }

    /* Custom scrollbar */
    /* Not supported on firefox, but the default scrollbar looks fine as-is */
    ul::-webkit-scrollbar {
        height: 6px;
    }

    ul::-webkit-scrollbar-thumb {
        border-radius: 3px;
        background: #777;
    }

    ul::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    ul::-webkit-scrollbar-track {
        background-color: var(--dark-background-color);
    }

    .scroll-wrapper {
        position: relative;
        overflow: hidden;
    }

    #spotifyHistory > li {
        margin: 0 8px;
    }

    .fade {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 40px;
        pointer-events: none; /* let mouse clicks pass through */
        z-index: 10;
        margin-top: 10px;
        margin-bottom: 10px;
    }

    .fade-left {
        left: 0;
        background: linear-gradient(to right, #000, transparent);
    }

    .fade-right {
        right: 0;
        background: linear-gradient(to left, #000, transparent);
    }

</style>

<h2>What I've been listening to</h2>
<div class="scroll-wrapper">
    <ul id="spotifyHistory">
            {
            history.map(({track, playedAt}, idx) => (
                <li>
                    <SpotifyTrackCard
                        track={track}
                        trackName={track.name}
                        artistName={track.artists[0].name}
                        coverImageUrl={images[idx]}
                        playedAt={playedAt}
                    />
                </li>
            ))
        }
    </ul>
    <div class="fade fade-left" />
    <div class="fade fade-right" />
</div>

<script>
    let mouseDown = false;
    let startX: number = 0;
    let scrollLeft: number = 0;
    const slider: HTMLUListElement = document.getElementById("spotifyHistory")! as HTMLUListElement;

    const startDragging = (e: MouseEvent) => {
        mouseDown = true;
        startX = e.pageX - slider.offsetLeft;
        scrollLeft = slider.scrollLeft;
    }

    const stopDragging = (e: MouseEvent) => {
        mouseDown = false;
    }

    const move = (e: MouseEvent) => {
        e.preventDefault();
        if (!mouseDown) return;
        const x = e.pageX - slider.offsetLeft;
        const scroll = x - startX;
        slider.scrollLeft = scrollLeft - scroll
    }

    // Add the event listeners
    slider.addEventListener('mousemove', move, false);
    slider.addEventListener('mousedown', startDragging, false);
    slider.addEventListener('mouseup', stopDragging, false);
    slider.addEventListener('mouseleave', stopDragging, false);

    const container = document.getElementById('spotifyHistory') as HTMLUListElement;
    const fadeLeft = document.querySelector('.fade-left')! as HTMLDivElement;
    const fadeRight = document.querySelector('.fade-right')! as HTMLDivElement  ;

    function updateFades() {
        const maxScroll = container.scrollWidth - container.clientWidth;
    
        fadeLeft.style.opacity = container.scrollLeft > 0 ? '1' : '0';
        fadeRight.style.opacity = container.scrollLeft < maxScroll ? '1' : '0';
    }

    container.addEventListener('scroll', updateFades);
    window.addEventListener('resize', updateFades);

    // Run on load
    updateFades();
</script>
