---
import { Track } from "../../api/types";
import SpotifyTrackCard from "./SpotifyTrackCard.astro";

// const data = await fetch("https://localhost:8080/users").then((response) => response.json());
let data = [
    `{  "album": {    "album_type": "single",    "total_tracks": 1,    "external_urls": {      "spotify": "https://open.spotify.com/album/0tGPJ0bkWOUmH7MEOR77qc"    },    "href": "https://api.spotify.com/v1/albums/0tGPJ0bkWOUmH7MEOR77qc",    "id": "0tGPJ0bkWOUmH7MEOR77qc",    "images": [      {        "url": "https://i.scdn.co/image/ab67616d0000b2737359994525d219f64872d3b1",        "height": 640,        "width": 640      },      {        "url": "https://i.scdn.co/image/ab67616d00001e027359994525d219f64872d3b1",        "height": 300,        "width": 300      },      {        "url": "https://i.scdn.co/image/ab67616d000048517359994525d219f64872d3b1",        "height": 64,        "width": 64      }    ],    "name": "Cut To The Feeling",    "release_date": "2017-05-26",    "release_date_precision": "day",    "type": "album",    "uri": "spotify:album:0tGPJ0bkWOUmH7MEOR77qc",    "artists": [      {        "external_urls": {          "spotify": "https://open.spotify.com/artist/6sFIWsNpZYqfjUpaCgueju"        },        "href": "https://api.spotify.com/v1/artists/6sFIWsNpZYqfjUpaCgueju",        "id": "6sFIWsNpZYqfjUpaCgueju",        "name": "Carly Rae Jepsen",        "type": "artist",        "uri": "spotify:artist:6sFIWsNpZYqfjUpaCgueju"      }    ],    "is_playable": true  },  "artists": [    {      "external_urls": {        "spotify": "https://open.spotify.com/artist/6sFIWsNpZYqfjUpaCgueju"      },      "href": "https://api.spotify.com/v1/artists/6sFIWsNpZYqfjUpaCgueju",      "id": "6sFIWsNpZYqfjUpaCgueju",      "name": "Carly Rae Jepsen",      "type": "artist",      "uri": "spotify:artist:6sFIWsNpZYqfjUpaCgueju"    }  ],  "disc_number": 1,  "duration_ms": 207959,  "explicit": false,  "external_ids": {    "isrc": "USUM71703861"  },  "external_urls": {    "spotify": "https://open.spotify.com/track/11dFghVXANMlKmJXsNCbNl"  },  "href": "https://api.spotify.com/v1/tracks/11dFghVXANMlKmJXsNCbNl",  "id": "6EJiVf7U0p1BBfs0qqeb1f",  "is_playable": true,  "linked_from": {    "external_urls": {      "spotify": "https://open.spotify.com/track/11dFghVXANMlKmJXsNCbNl"    },    "href": "https://api.spotify.com/v1/tracks/11dFghVXANMlKmJXsNCbNl",    "id": "11dFghVXANMlKmJXsNCbNl",    "type": "track",    "uri": "spotify:track:11dFghVXANMlKmJXsNCbNl"  },  "name": "Cut To The Feeling",  "popularity": 0,  "preview_url": null,  "track_number": 1,  "type": "track",  "uri": "spotify:track:6EJiVf7U0p1BBfs0qqeb1f",  "is_local": false}`,
    `{  "album": {    "album_type": "album",    "total_tracks": 31,    "external_urls": {      "spotify": "https://open.spotify.com/album/0bQglEvsHphrS19FGODEGo"    },    "href": "https://api.spotify.com/v1/albums/0bQglEvsHphrS19FGODEGo",    "id": "0bQglEvsHphrS19FGODEGo",    "images": [      {        "url": "https://i.scdn.co/image/ab67616d0000b2735274788f34fc7656d2856dfd",        "height": 640,        "width": 640      },      {        "url": "https://i.scdn.co/image/ab67616d00001e025274788f34fc7656d2856dfd",        "height": 300,        "width": 300      },      {        "url": "https://i.scdn.co/image/ab67616d000048515274788f34fc7656d2856dfd",        "height": 64,        "width": 64      }    ],    "name": "Siamese Dream (Deluxe Edition)",    "release_date": "1993",    "release_date_precision": "year",    "type": "album",    "uri": "spotify:album:0bQglEvsHphrS19FGODEGo",    "artists": [      {        "external_urls": {          "spotify": "https://open.spotify.com/artist/40Yq4vzPs9VNUrIBG5Jr2i"        },        "href": "https://api.spotify.com/v1/artists/40Yq4vzPs9VNUrIBG5Jr2i",        "id": "40Yq4vzPs9VNUrIBG5Jr2i",        "name": "The Smashing Pumpkins",        "type": "artist",        "uri": "spotify:artist:40Yq4vzPs9VNUrIBG5Jr2i"      }    ],    "is_playable": true  },  "artists": [    {      "external_urls": {        "spotify": "https://open.spotify.com/artist/40Yq4vzPs9VNUrIBG5Jr2i"      },      "href": "https://api.spotify.com/v1/artists/40Yq4vzPs9VNUrIBG5Jr2i",      "id": "40Yq4vzPs9VNUrIBG5Jr2i",      "name": "The Smashing Pumpkins",      "type": "artist",      "uri": "spotify:artist:40Yq4vzPs9VNUrIBG5Jr2i"    }  ],  "disc_number": 1,  "duration_ms": 298253,  "explicit": false,  "external_ids": {    "isrc": "USVI21100146"  },  "external_urls": {    "spotify": "https://open.spotify.com/track/3ow0TQVttXQF8rLckmXgRx"  },  "href": "https://api.spotify.com/v1/tracks/3ow0TQVttXQF8rLckmXgRx",  "id": "3ow0TQVttXQF8rLckmXgRx",  "is_playable": true,  "name": "Cherub Rock - 2011 Remaster",  "popularity": 68,  "preview_url": null,  "track_number": 1,  "type": "track",  "uri": "spotify:track:3ow0TQVttXQF8rLckmXgRx",  "is_local": false}`,
].map((obj) => JSON.parse(obj) as Track);

data = [...data, ...data, ...data];
---
<style>
    ul {
        /* Give some buffer space at either side */
        width: calc(100% - 16px);
        margin: 0 auto;

        list-style-type: none;
        display: flex;
        flex-direction: row;
        overflow: auto;
        white-space: norwap;

        padding-left: unset;
    }

    .horizontal-scroll {
        scroll-behavior: smooth;
        user-select: none;
        cursor: grab;
        -webkit-overflow-scrolling: touch;
    }

    .horizontal-scroll.dragging {
        cursor: grabbing;
    }
</style>

<script>
    const list = document.getElementById("spotify-history")!;
    let isDown = false;
    let startX: number;
    let scrollLeft: number;

    list.addEventListener("mousedown", (e) => {
        isDown = true;
        list.classList.add("dragging");
        startX = e.pageX - list.offsetLeft;
        scrollLeft = list.scrollLeft;
    });

    list.addEventListener("mouseleave", () => {
        isDown = false;
        list.classList.remove("dragging");
    });

    list.addEventListener("mouseup", () => {
        isDown = false;
        list.classList.remove("dragging");
    });

    list.addEventListener("mousemove", (e) => {
        if (!isDown) return;
        e.preventDefault();
        const x = e.pageX - list.offsetLeft;
        const walk = (x - startX) * 1.5; // adjust multiplier as needed
        list.scrollLeft = scrollLeft - walk;
    });

    // Touch support
    list.addEventListener("touchstart", (e) => {
        isDown = true;
        startX = e.touches[0].pageX - list.offsetLeft;
        scrollLeft = list.scrollLeft;
    });

    list.addEventListener("touchmove", (e) => {
        if (!isDown) return;
        const x = e.touches[0].pageX - list.offsetLeft;
        const walk = (x - startX) * 1.5;
        list.scrollLeft = scrollLeft - walk;
    });

    list.addEventListener("touchend", () => {
        isDown = false;
    });
</script>

<ul id="spotify-history" class="horizontal-scroll">
    {
        data.map((track, idx) => (
            <li>
                <SpotifyTrackCard key={idx} track={track} />
            </li>
        ))
    }
</ul>
